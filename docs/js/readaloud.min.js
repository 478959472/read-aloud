function connect(e){window.docReady||(window.docReady=makeDoc()),window.docReady.then(function(t){startService(e,t)})}function startService(e,t){function n(e,t){var n=t.request;if(e[n.method]){var r=e[n.method](n);Promise.resolve(r).then(function(e){a.postMessage({id:t.id,response:e})})}}function r(e){return{isPdf:t.isPdf,canSeek:t.canSeek,url:location.href,title:document.title,lang:document.documentElement.lang||$("html").attr("xml:lang")||$("meta[http-equiv=content-language]").attr("content")}}function o(e){return u()?-100:t.getCurrentIndex()}function i(e){return e.index<0?-100==e.index?[u()]:null:Promise.resolve(t.getTexts(e.index)).then(function(e){return e&&(e=e.map(removeLinks),console.log(e.join("\n\n"))),e})}function u(){return window.getSelection().toString().trim()}var a=chrome.runtime.connect({name:e});a.onMessage.addListener(n.bind(null,{raGetInfo:r,raGetCurrentIndex:o,raGetTexts:i}))}function makeDoc(){function e(){return"docs.google.com"==location.hostname?$(".kix-appview-editor").length?new GoogleDoc:$(".drive-viewer-paginated-scrollable").length?new GDriveDoc:new HtmlDoc:"drive.google.com"==location.hostname?new GDriveDoc:"read.amazon.com"==location.hostname?new KindleBook:location.pathname.match(/\.pdf$/)?new PdfDoc(location.href):new HtmlDoc}return function(){return new Promise(function(e){$(e)})}().then(e).then(function(e){return Promise.resolve(e.ready).then(function(){return e})})}function GoogleDoc(){function e(){return $(".kix-paragraphrenderer",this).get().map(getText).filter(isNotEmpty)}var t=$(".kix-appview-editor").get(0),n=$(".kix-page");this.getCurrentIndex=function(){for(var e=0;e<n.length&&!(n.eq(e).position().top>t.scrollTop+$(t).height()/2);e++);return e-1},this.getTexts=function(r){var o=n.get(r);return o?(t.scrollTop=$(o).position().top,tryGetTexts(e.bind(o),2e3)):null}}function GDriveDoc(){function e(){return fixParagraphs($("p",this).get().map(getText).filter(isNotEmpty))}var t=$(".drive-viewer-paginated-scrollable").get(0),n=$(".drive-viewer-paginated-page");this.getCurrentIndex=function(){for(var e=0;e<n.length&&!(n.eq(e).position().top>t.scrollTop+$(t).height()/2);e++);return e-1},this.getTexts=function(r){var o=n.get(r);return o?(t.scrollTop=$(o).position().top,tryGetTexts(e.bind(o),3e3)):null}}function KindleBook(){function e(){var e=[];i.filter(function(e){return"hidden"!=e.style.visibility}).forEach(function(t){var n=$(t).height();$("h1, h2, h3, h4, h5, h6, .was-a-p",t.contentDocument).each(function(){var t=$(this).offset().top;$(this).height();t>=0&&t<n&&e.push($(this).text())})});for(var n=[],r=0;r<e.length;r++)e[r]!=(n.length?n[n.length-1]:t)&&n.push(e[r]);return t=n[n.length-1],n}var t,n=document.getElementById("KindleReaderIFrame").contentDocument,r=n.getElementById("kindleReader_pageTurnAreaRight"),o=n.getElementById("kindleReader_pageTurnAreaLeft"),i=[n.getElementById("column_0_frame_0"),n.getElementById("column_0_frame_1"),n.getElementById("column_1_frame_0"),n.getElementById("column_1_frame_1")],u=0;this.getCurrentIndex=function(){return u=0},this.getTexts=function(t){for(;u<t;u++)$(r).click();for(;u>t;u--)$(o).click();return tryGetTexts(e,4e3)}}function PdfDoc(e){function t(e){return e.getTextContent().then(function(e){return e.items.map(function(e){return e.str.trim()}).filter(isNotEmpty)}).then(fixParagraphs)}function n(){return r?Promise.resolve():(PDFJS.workerSrc="//mozilla.github.io/pdf.js/build/pdf.worker.js",PDFJS.getDocument(e).promise.then(function(e){r=e}))}var r;this.isPdf=!0,this.canSeek=!0,this.getCurrentIndex=function(){return 0},this.getTexts=function(e){return n().then(function(){return e<r.numPages?r.getPage(e+1).then(t):null})}}function HtmlDoc(){function e(){$(".read-aloud").removeClass("read-aloud");var e=$("p").not("blockquote > p").parent().get();if($.uniqueSort(e),e=$(e).filter(":visible").filter(notOutOfView).get(),e.length){var n=e.map(function(e){return $(e).children(i.join(", ")).text().length}),r=Math.max.apply(null,n);e=e.filter(function(e,t){return n[t]>r/7}),e.forEach(function(e){$(t(e)).addClass("read-aloud"),$(e).children(o.concat(i).join(", ")).addClass("read-aloud"),$(e).children(u.join(", ")).children("li").addClass("read-aloud")})}else $(o.concat(i).join(", ")).filter(":visible").addClass("read-aloud");return $(".read-aloud").get().map(getText).filter(isNotEmpty)}function t(e){for(var t=[],u=$(e).children(o.concat(i).join(", ")).get(0),a=n(u),s=r(u,!0);s&&!$(s).hasClass("read-aloud");){if(1==s.nodeType){var c=n(s);c<a&&(t.push(s),a=c)}s=r(s)}return t.reverse()}function n(e){var t=e?o.indexOf(e.tagName):-1;return-1==t?100:t+1}function r(e,t){return e==document.body?null:1==e.nodeType&&!t&&e.lastChild?e.lastChild:e.previousSibling?e.previousSibling:r(e.parentNode,!0)}var o=["H1","H2","H3","H4","H5","H6"],i=["P","BLOCKQUOTE","PRE"],u=["OL","UL"];this.getCurrentIndex=function(){return 0},this.getTexts=function(t){return 0==t?e():null}}function notOutOfView(){return $(this).offset().left>=0}function getText(e){$(e).find(":hidden, sup").remove();var t=$(e).text().trim();return"LI"==e.tagName?$(e).index()+1+". "+t:t}function isNotEmpty(e){return e}function removeLinks(e){return e.replace(/https?:\/\/\S+/g,"this URL.")}function waitMillis(e){return new Promise(function(t){setTimeout(t,e)})}function fixParagraphs(e){for(var t=[],n="",r=0;r<e.length;r++)n&&(/-$/.test(n)?n=n.substr(0,n.length-1):n+=" "),n+=e[r].replace(/-\r?\n/g,""),e[r].match(/[.!?:)"'\u2019\u201d]$/)&&(t.push(n),n="");return n&&t.push(n),t}function tryGetTexts(e,t){return waitMillis(500).then(e).then(function(n){return n&&!n.length&&t-500>0?tryGetTexts(e,t-500):n})}function Speech(e,t){function n(){return new Promise(function(e){m.isSpeaking(function(t){e(v?t?"PLAYING":"LOADING":"PAUSED")})})}function r(){return w[0]>=e.length?(t.hack&&clearTimeout(x),v=!1,t.onEnd&&t.onEnd(),Promise.resolve()):(t.hack&&(clearTimeout(x),x=setTimeout(o,16*1e3)),v=(new Date).getTime(),new Promise(function(t){l(e[w[0]][w[1]],t,i)}))}function o(){m.isSpeaking(function(e){e&&i()})}function i(){return w[1]++,w[1]>=e[w[0]].length&&(w=[w[0]+1,0]),r()}function u(){return t.hack&&clearTimeout(x),m.stop(),v=!1,Promise.resolve()}function a(){return w[0]+1<e.length?(w=[w[0]+1,0],r()):Promise.reject(new Error("Can't forward, at end"))}function s(){return v&&(new Date).getTime()-v>3*1e3?(w=[w[0],0],r()):w[0]>0?(w=[w[0]-1,0],r()):Promise.reject(new Error("Can't rewind, at beginning"))}function c(){w=[Math.max(e.length-1,0),0]}function l(e,n,r){m.speak(e,{voiceName:t.voiceName,lang:t.lang,rate:Math.min(t.rate,2),pitch:t.pitch,volume:t.volume,requiredEventTypes:["start","end"],desiredEventTypes:["start","end"],onEvent:function(e){"start"==e.type?n():"end"==e.type&&r()}})}function h(){function e(e,n,o){return r(o.getSentences(e),n,o,t)}function t(e,t,o){return r(o.getPhrases(e),t,o,n)}function n(e,t,n){for(var r=n.getWords(e),o=Math.min(Math.ceil(r.length/2),t),i=[];r.length;)i.push(r.slice(0,o).join("")),r=r.slice(o);return i}function r(e,t,n,r){var o=[],i={parts:[],wordCount:0},u=function(){i.parts.length&&(o.push(i.parts.join("")),i={parts:[],wordCount:0})};return e.forEach(function(e){var a=n.getWords(e).length;if(a>t){u();for(var s=r(e,t,n),c=0;c<s.length;c++)o.push(s[c])}else i.wordCount+a>t&&u(),i.parts.push(e),i.wordCount+=a}),u(),o}this.breakText=e}function f(){function e(e,n,o){return r(o.getSentences(e),n,o,t)}function t(e,t,o){return r(o.getPhrases(e),t,o,n)}function n(e,t,n){return r(n.getWords(e),t,n)}function r(e,t,n,r){var o=[],i={parts:[],charCount:0},u=function(){i.parts.length&&(o.push(i.parts.join("")),i={parts:[],charCount:0})};return e.forEach(function(e){var a=e.length;if(a>t){u();for(var s=r(e,t,n),c=0;c<s.length;c++)o.push(s[c])}else i.charCount+a>t&&u(),i.parts.push(e),i.charCount+=a}),u(),o}this.breakText=e}function d(){this.getSentences=function(e){for(var t=e.split(/([.!?]+[\s\u200b])/),n=[],r=0;r<t.length;r+=2)r+1<t.length?n.push(t[r]+t[r+1]):n.push(t[r]);return n},this.getPhrases=function(e){for(var t=e.split(/([,;:]\s|\s-+\s|—)/),n=[],r=0;r<t.length;r+=2)r+1<t.length?n.push(t[r]+t[r+1]):n.push(t[r]);return n},this.getWords=function(e){for(var t=e.trim().split(/([~@#%^*_+=<>]|[\s\-—\/]+|\.(?=\w{2,})|,(?=[0-9]))/),n=[],r=0;r<t.length;r+=2)t[r]&&n.push(t[r]),r+1<t.length&&(/^[~@#%^*_+=<>]$/.test(t[r+1])?n.push(t[r+1]):n.length&&(n[n.length-1]+=t[r+1]));return n}}function g(){this.getSentences=function(e){for(var t=e.split(/([.!?]+[\s\u200b]|[\u3002\uff01])/),n=[],r=0;r<t.length;r+=2)r+1<t.length?n.push(t[r]+t[r+1]):n.push(t[r]);return n},this.getPhrases=function(e){for(var t=e.split(/([,;:]\s|[\u2025\u2026\u3000\u3001\uff0c\uff1b])/),n=[],r=0;r<t.length;r+=2)r+1<t.length?n.push(t[r]+t[r+1]):n.push(t[r]);return n},this.getWords=function(e){return e.replace(/\s+/g,"").split("")}}t.spchletMaxLen||(t.spchletMaxLen=36);var p;/^zh|ko|ja/.test(t.lang)?(p=new g,t.spchletMaxLen*=2):p=new d;var m=t.engine||chrome.tts,v=!1,w=[0,0],x=0;isCustomVoice(t.voiceName)?(e=e.map(function(e){return(new f).breakText(e,200,p)}),t.hack=!1):(e=e.map(function(e){return(new h).breakText(e,t.spchletMaxLen,p)}),t.hack=!0),this.options=t,this.play=r,this.pause=u,this.getState=n,this.forward=a,this.rewind=s,this.gotoEnd=c}function GoogleTranslateTTS(e){var t=document.createElement("AUDIO");this.speak=function(n,r,o){o||(o=r.onEvent),t.pause(),r.volume&&(t.volume=r.volume),r.rate&&(t.defaultPlaybackRate=r.rate),t.src=e+"/read-aloud/speak/"+r.lang+"?q="+encodeURIComponent(n),t.onplay=o.bind(null,{type:"start",charIndex:0}),t.onerror=t.onended=o.bind(null,{type:"end",charIndex:n.length}),t.play()},this.isSpeaking=function(e){e(t.currentTime&&!t.paused&&!t.ended)},this.stop=function(){t.pause()}}!function(){if(window.chrome&&chrome.ttsEngine){var e=new GoogleTranslateTTS("http://app.diepkhuc.com:30112");chrome.ttsEngine.onSpeak.addListener(e.speak),chrome.ttsEngine.onStop.addListener(e.stop)}}();var readAloud=new function(){function e(){return t().then(function(e){$(".ra-play").toggle(!e),$(".ra-pause").toggle(e)})}function t(){return o?o.getState().then(function(e){return"PAUSED"!=e}):Promise.resolve(!1)}function n(){function e(e,n){var r=t(n),o={};return e.forEach(function(e){if(e.lang){var n=t(e.lang);n.lang==r.lang&&(n.rest==r.rest?"female"==e.gender?o.first=o.first||e:o.second=o.second||e:n.rest?"en"==n.lang&&"us"==n.rest?o.fourth=e:o.fourth=o.fourth||e:o.third=o.third||e)}}),o.first||o.second||o.third||o.fourth}function t(e){var t=e.toLowerCase().split(/[-_]/,2);return{lang:t[0],rest:t[1]}}window.speechSynthesis&&speechSynthesis.getVoices(),window.isCustomVoice=function(e){return!e},this.getVoice=function(t){var n=window.speechSynthesis?e(speechSynthesis.getVoices(),t):null;return Promise.resolve(n)}}function r(e){var t;this.speak=function(n,r){t=new SpeechSynthesisUtterance,r.lang&&(t.lang=r.lang),r.pitch&&(t.pitch=r.pitch),r.rate&&(t.rate=r.rate),t.text=n,t.voice=e,r.volume&&(t.volume=r.volume),t.onstart=r.onEvent.bind(null,{type:"start",charIndex:0}),t.onerror=t.onend=r.onEvent.bind(null,{type:"end",charIndex:n.length}),speechSynthesis.speak(t)},this.isSpeaking=function(e){e(speechSynthesis.speaking)},this.stop=function(){t&&(t.onend=null),speechSynthesis.cancel()}}var o,i=new n;this.play=function(t){return o?o.play().then(e):window.Promise?i.getVoice(t.lang).then(function(n){return t.voiceName=n?n.name:null,t.engine=n?new r(n):new GoogleTranslateTTS("https://test.diepkhuc.com:30113"),t.onEnd=function(){o=null,e()},o=new Speech((new HtmlDoc).getTexts(0),t),o.play().then(e)}):alert("Browser not supported")},this.pause=function(){return o?o.pause().then(e):Promise.resolve()},$(e)};