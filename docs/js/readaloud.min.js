function getQueryString(){var e={};return location.search&&location.search.substr(1).replace(/\+/g,"%20").split("&").forEach(function(n){var t=n.split("=");e[decodeURIComponent(t[0])]=t[1]&&decodeURIComponent(t[1])}),e}function getSettings(){return new Promise(function(e){chrome.storage.local.get(["voiceName","rate","pitch","volume","showHighlighting"],e)})}function updateSettings(e){return new Promise(function(n){chrome.storage.local.set(e,n)})}function clearSettings(){return new Promise(function(e){chrome.storage.local.remove(["voiceName","rate","pitch","volume","showHighlighting"],e)})}function getState(e){return new Promise(function(n){chrome.storage.local.get(e,function(t){n(t[e])})})}function setState(e,n){var t={};return t[e]=n,new Promise(function(e){chrome.storage.local.set(t,e)})}function getVoices(){return new Promise(function(e){chrome.tts.getVoices(e)})}function isGoogleNative(e){return/^Google /.test(e)}function isGoogleTranslate(e){return/^GoogleTranslate /.test(e)}function isAmazonPolly(e){return/^Amazon /.test(e)}function isRemoteVoice(e){return isAmazonPolly(e)||isGoogleTranslate(e)}function isPremiumVoice(e){return isAmazonPolly(e)}function executeFile(e){return new Promise(function(n,t){chrome.runtime.lastError=null,chrome.tabs.executeScript({file:e},function(e){chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):n(e)})})}function executeScript(e){return new Promise(function(n,t){chrome.runtime.lastError=null,chrome.tabs.executeScript({code:e},function(e){chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):n(e)})})}function insertCSS(e){return new Promise(function(n,t){chrome.runtime.lastError=null,chrome.tabs.insertCSS({file:e},function(e){chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):n(e)})})}function getBackgroundPage(){return new Promise(function(e){chrome.runtime.getBackgroundPage(e)})}function spread(e,n){return function(t){return e.apply(n,t)}}function callMethod(e,n){return function(t){return t[e].apply(t,n)}}function waitMillis(e){return new Promise(function(n){setTimeout(n,e)})}function parseLang(e){var n=e.toLowerCase().replace(/_/g,"-").split(/-/,2);return{lang:n[0],rest:n[1]}}function formatError(e){var n=chrome.i18n.getMessage(e.code);return n&&(n=n.replace(/{(\w+)}/g,function(n,t){return e[t]})),n}function urlEncode(e){if(null==e)return null;var n=[];for(var t in e)n.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return n.join("&")}function ajaxGet(e){return new Promise(ajaxGetCb.bind(null,e))}function ajaxGetCb(e,n,t){var r=new XMLHttpRequest;r.open("GET",e,!0),r.onreadystatechange=function(){r.readyState==XMLHttpRequest.DONE&&(200==r.status?n(r.responseText):t&&t(new Error(r.responseText)))},r.send(null)}function ajaxPost(e,n,t){return new Promise(function(r,o){var a=new XMLHttpRequest;a.open("POST",e,!0),a.setRequestHeader("Content-type","json"==t?"application/json":"application/x-www-form-urlencoded"),a.onreadystatechange=function(){a.readyState==XMLHttpRequest.DONE&&(200==a.status?r(a.responseText):o(new Error(a.responseText)))},a.send("json"==t?JSON.stringify(n):urlEncode(n))})}function Speech(e,n){function t(){return p[0]>=e.length?(n.hack&&clearTimeout(h),u=!1,n.onEnd&&n.onEnd(),Promise.resolve()):(n.hack&&(clearTimeout(h),h=setTimeout(r,16*1e3)),u=(new Date).getTime(),new Promise(function(t){a(e[p[0]][p[1]],t,function(e){e?(n.hack&&clearTimeout(h),u=!1,n.onEnd&&n.onEnd(e)):o()})}))}function r(){c.isSpeaking(function(e){e&&o()})}function o(){return p[1]++,p[1]>=e[p[0]].length&&(p=[p[0]+1,0]),t()}function a(e,t,r){c.speak(e,{voiceName:n.voiceName,lang:n.lang,rate:n.rate,pitch:n.pitch,volume:n.volume,requiredEventTypes:["start","end"],desiredEventTypes:["start","end","error"],onEvent:function(e){"start"==e.type?t():"end"==e.type?r():"error"==e.type&&r(new Error(e.errorMessage||"Unknown TTS error"))}})}function i(){function e(e,r,o){return t(o.getPhrases(e),r,o,n)}function n(e,n,t){for(var r=t.getWords(e),o=Math.min(Math.ceil(r.length/2),n),a=[];r.length;)a.push(r.slice(0,o).join("")),r=r.slice(o);return a}function t(e,n,t,r){var o=[],a={parts:[],wordCount:0},i=function(){a.parts.length&&(o.push(a.parts.join("")),a={parts:[],wordCount:0})};return e.forEach(function(e){var s=t.getWords(e).length;if(s>n){i();for(var l=r(e,n,t),c=0;c<l.length;c++)o.push(l[c])}else a.wordCount+s>n&&i(),a.parts.push(e),a.wordCount+=s}),i(),o}this.breakText=function(n,r,o){return t(o.getSentences(n),r,o,e)}}function s(){function e(e,r,o){return t(o.getPhrases(e),r,o,n)}function n(e,n,r){return t(r.getWords(e),n,r)}function t(e,n,t,r){var o=[],a={parts:[],charCount:0},i=function(){a.parts.length&&(o.push(a.parts.join("")),a={parts:[],charCount:0})};return e.forEach(function(e){var s=e.length;if(s>n){i();for(var l=r(e,n,t),c=0;c<l.length;c++)o.push(l[c])}else a.charCount+s>n&&i(),a.parts.push(e),a.charCount+=s}),i(),o}this.breakText=function(n,r,o){return t(o.getSentences(n),r,o,e)}}n.spchletMaxLen||(n.spchletMaxLen=36),n.rate||(n.rate=1);var l;/^zh|ko|ja/.test(n.lang)?(l=new function(){this.getSentences=function(e){for(var n=e.split(/([.!?]+[\s\u200b]|[\u3002\uff01])/),t=[],r=0;r<n.length;r+=2)r+1<n.length?t.push(n[r]+n[r+1]):t.push(n[r]);return t},this.getPhrases=function(e){for(var n=e.split(/([,;:]\s|[\u2025\u2026\u3000\u3001\uff0c\uff1b])/),t=[],r=0;r<n.length;r+=2)r+1<n.length?t.push(n[r]+n[r+1]):t.push(n[r]);return t},this.getWords=function(e){return e.replace(/\s+/g,"").split("")}},n.spchletMaxLen*=2):l=new function(){this.getSentences=function(e){for(var n=e.split(/([.!?]+[\s\u200b])/),t=[],r=0;r<n.length;r+=2)r+1<n.length?t.push(n[r]+n[r+1]):t.push(n[r]);return t},this.getPhrases=function(e){for(var n=e.split(/([,;:]\s|\s-+\s|—)/),t=[],r=0;r<n.length;r+=2)r+1<n.length?t.push(n[r]+n[r+1]):t.push(n[r]);return t},this.getWords=function(e){for(var n=e.trim().split(/([~@#%^*_+=<>]|[\s\-—/]+|\.(?=\w{2,})|,(?=[0-9]))/),t=[],r=0;r<n.length;r+=2)n[r]&&t.push(n[r]),r+1<n.length&&(/^[~@#%^*_+=<>]$/.test(n[r+1])?t.push(n[r+1]):t.length&&(t[t.length-1]+=n[r+1]));return t}};var c=n.engine||chrome.tts,u=!1,p=[0,0],h=0;isAmazonPolly(n.voiceName)||isGoogleTranslate(n.voiceName)?(e=e.map(function(e){return(new s).breakText(e,200,l)}),n.hack=!1):isGoogleNative(n.voiceName)?(e=e.map(function(e){return(new i).breakText(e,n.spchletMaxLen*n.rate,l)}),n.hack=!0):(e=e.map(function(e){return[e]}),n.hack=!1),this.options=n,this.play=t,this.pause=function(){return n.hack&&clearTimeout(h),c.stop(),u=!1,Promise.resolve()},this.getState=function(){return new Promise(function(e){c.isSpeaking(function(n){e(u?n?"PLAYING":"LOADING":"PAUSED")})})},this.getPosition=function(){return{index:p,texts:e}},this.forward=function(){return p[0]+1<e.length?(p=[p[0]+1,0],t()):Promise.reject(new Error("Can't forward, at end"))},this.rewind=function(){return u&&(new Date).getTime()-u>3*1e3?(p=[p[0],0],t()):p[0]>0?(p=[p[0]-1,0],t()):Promise.reject(new Error("Can't rewind, at beginning"))},this.gotoEnd=function(){p=[Math.max(e.length-1,0),0]}}function RemoteTTS(e){function n(e){return isGoogleTranslate(e)?1.2:1}var t=window.ttsAudio;t||(t=window.ttsAudio=document.createElement("AUDIO")),this.speak=function(r,o,a){a||(a=o.onEvent),t.pause(),t.volume=o.volume||1,t.defaultPlaybackRate=(o.rate||1)*n(o.voiceName),t.src=e+"/read-aloud/speak/"+o.lang+"/"+encodeURIComponent(o.voiceName)+"?q="+encodeURIComponent(r),t.onplay=a.bind(null,{type:"start",charIndex:0}),t.onerror=a.bind(null,{type:"error",errorMessage:"TTS server error"}),t.onended=a.bind(null,{type:"end",charIndex:r.length}),t.play()},this.isSpeaking=function(e){e(t.currentTime&&!t.paused&&!t.ended)},this.stop=function(){t.pause()}}var remoteVoices=[{voice_name:"GoogleTranslate Afrikaans",lang:"af",event_types:["start","end"]},{voice_name:"GoogleTranslate Albanian",lang:"sq",event_types:["start","end"]},{voice_name:"GoogleTranslate Arabic",lang:"ar",event_types:["start","end"]},{voice_name:"GoogleTranslate Armenian",lang:"hy",event_types:["start","end"]},{voice_name:"GoogleTranslate Bengali",lang:"bn",event_types:["start","end"]},{voice_name:"GoogleTranslate Bosnian",lang:"bs",event_types:["start","end"]},{voice_name:"GoogleTranslate Catalan",lang:"ca",event_types:["start","end"]},{voice_name:"GoogleTranslate Chinese",lang:"zh-CN",event_types:["start","end"]},{voice_name:"GoogleTranslate Croatian",lang:"hr",event_types:["start","end"]},{voice_name:"GoogleTranslate Czech",lang:"cs",event_types:["start","end"]},{voice_name:"GoogleTranslate Danish",lang:"da",event_types:["start","end"]},{voice_name:"GoogleTranslate Dutch",lang:"nl",event_types:["start","end"]},{voice_name:"GoogleTranslate English",lang:"en",event_types:["start","end"]},{voice_name:"GoogleTranslate Esperanto",lang:"eo",event_types:["start","end"]},{voice_name:"GoogleTranslate Finnish",lang:"fi",event_types:["start","end"]},{voice_name:"GoogleTranslate French",lang:"fr",event_types:["start","end"]},{voice_name:"GoogleTranslate German",lang:"de",event_types:["start","end"]},{voice_name:"GoogleTranslate Greek",lang:"el",event_types:["start","end"]},{voice_name:"GoogleTranslate Hindi",lang:"hi",event_types:["start","end"]},{voice_name:"GoogleTranslate Hungarian",lang:"hu",event_types:["start","end"]},{voice_name:"GoogleTranslate Icelandic",lang:"is",event_types:["start","end"]},{voice_name:"GoogleTranslate Indonesian",lang:"id",event_types:["start","end"]},{voice_name:"GoogleTranslate Italian",lang:"it",event_types:["start","end"]},{voice_name:"GoogleTranslate Japanese",lang:"ja",event_types:["start","end"]},{voice_name:"GoogleTranslate Khmer",lang:"km",event_types:["start","end"]},{voice_name:"GoogleTranslate Korean",lang:"ko",event_types:["start","end"]},{voice_name:"GoogleTranslate Latin",lang:"la",event_types:["start","end"]},{voice_name:"GoogleTranslate Latvian",lang:"lv",event_types:["start","end"]},{voice_name:"GoogleTranslate Macedonian",lang:"mk",event_types:["start","end"]},{voice_name:"GoogleTranslate Nepali",lang:"ne",event_types:["start","end"]},{voice_name:"GoogleTranslate Norwegian",lang:"no",event_types:["start","end"]},{voice_name:"GoogleTranslate Polish",lang:"pl",event_types:["start","end"]},{voice_name:"GoogleTranslate Portuguese",lang:"pt",event_types:["start","end"]},{voice_name:"GoogleTranslate Romanian",lang:"ro",event_types:["start","end"]},{voice_name:"GoogleTranslate Russian",lang:"ru",event_types:["start","end"]},{voice_name:"GoogleTranslate Serbian",lang:"sr",event_types:["start","end"]},{voice_name:"GoogleTranslate Sinhala",lang:"si",event_types:["start","end"]},{voice_name:"GoogleTranslate Slovak",lang:"sk",event_types:["start","end"]},{voice_name:"GoogleTranslate Spanish",lang:"es",event_types:["start","end"]},{voice_name:"GoogleTranslate Swahili",lang:"sw",event_types:["start","end"]},{voice_name:"GoogleTranslate Swedish",lang:"sv",event_types:["start","end"]},{voice_name:"GoogleTranslate Tamil",lang:"ta",event_types:["start","end"]},{voice_name:"GoogleTranslate Thai",lang:"th",event_types:["start","end"]},{voice_name:"GoogleTranslate Turkish",lang:"tr",event_types:["start","end"]},{voice_name:"GoogleTranslate Ukrainian",lang:"uk",event_types:["start","end"]},{voice_name:"GoogleTranslate Vietnamese",lang:"vi",event_types:["start","end"]},{voice_name:"GoogleTranslate Welsh",lang:"cy",event_types:["start","end"]}],config={serviceUrl:"https://support.lsdsoftware.com"},defaults={rate:1,pitch:1,volume:1,showHighlighting:0};!function(){function e(e,n){function t(){return window.getSelection().toString().trim()}function r(e){return e.replace(/https?:\/\/\S+/g,"this URL.")}var o=chrome.runtime.connect({name:e});o.onMessage.addListener(function(e,n){var t=n.request;if(e[t.method]){var r=e[t.method](t);Promise.resolve(r).then(function(e){o.postMessage({id:n.id,response:e})})}}.bind(null,{raGetInfo:function(e){var n=document.documentElement.lang||$("html").attr("xml:lang");return n&&(n=n.replace(/_/g,"-")),"en"!=n&&"en-US"!=n||(n=null),{url:location.href,title:document.title,lang:n}},raGetCurrentIndex:function(e){return t()?-100:n.getCurrentIndex()},raGetTexts:function(e){return e.index<0?-100==e.index?t().split(d.paraSplitter):null:Promise.resolve(n.getTexts(e.index)).then(function(e){return e&&(e=e.map(r),console.log(e.join("\n\n"))),e})}}))}function n(){return new Promise(function(e){$(e)}).then(function(){return"docs.google.com"==location.hostname?$(".kix-appview-editor").length?new t:$(".drive-viewer-paginated-scrollable").length?new r:new l:"drive.google.com"==location.hostname?new r:/^read\.amazon\./.test(location.hostname)?new o:"www.quora.com"==location.hostname?new i:"www.khanacademy.org"==location.hostname?new s:location.pathname.match(/\.pdf$/)?new a(location.href):$("embed[type='application/pdf']").length?new a($("embed[type='application/pdf']").attr("src")):new l}).then(function(e){return Promise.resolve(e.ready).then(function(){return e})})}function t(){function e(){return $(".kix-paragraphrenderer",this).get().map(c).filter(u)}var n=$(".kix-appview-editor").get(0),t=$(".kix-page");this.ready=d.loadScript(chrome.runtime.getURL("js/googleDocsUtil.js")),this.getCurrentIndex=function(){if(googleDocsUtil.getGoogleDocument().selectedText)return 9999;for(var e=0;e<t.length&&!(t.eq(e).position().top>n.scrollTop+$(n).height()/2);e++);return e-1},this.getTexts=function(r){if(9999==r)return[googleDocsUtil.getGoogleDocument().selectedText];var o=t.get(r);return o?(n.scrollTop=$(o).position().top,h(e.bind(o),2e3)):null}}function r(){function e(){return p($("p",this).get().map(c).filter(u))}var n=$(".drive-viewer-paginated-scrollable").get(0),t=$(".drive-viewer-paginated-page");this.getCurrentIndex=function(){for(var e=0;e<t.length&&!(t.eq(e).position().top>n.scrollTop+$(n).height()/2);e++);return e-1},this.getTexts=function(r){var o=t.get(r);return o?(n.scrollTop=$(o).position().top,h(e.bind(o),3e3)):null}}function o(){function e(){var e=[];a.filter(function(e){return"hidden"!=e.style.visibility}).forEach(function(n){var t=$(n).height();$("h1, h2, h3, h4, h5, h6, .was-a-p",n.contentDocument).each(function(){var n=$(this).offset().top;$(this).height();n>=0&&n<t&&e.push($(this).text())})});for(var t=[],r=0;r<e.length;r++)e[r]!=(t.length?t[t.length-1]:n)&&t.push(e[r]);return n=t[t.length-1],t}var n,t=document.getElementById("KindleReaderIFrame").contentDocument,r=t.getElementById("kindleReader_pageTurnAreaRight"),o=t.getElementById("kindleReader_pageTurnAreaLeft"),a=[t.getElementById("column_0_frame_0"),t.getElementById("column_0_frame_1"),t.getElementById("column_1_frame_0"),t.getElementById("column_1_frame_1")],i=0;this.getCurrentIndex=function(){return i=0},this.getTexts=function(n){for(;i<n;i++)$(r).click();for(;i>n;i--)$(o).click();return h(e,4e3)}}function a(e){function n(e){return e.getTextContent().then(function(e){for(var n=[],t=0;t<e.items.length;t++)(0==n.length||t>0&&e.items[t-1].transform[5]!=e.items[t].transform[5])&&n.push(""),n[n.length-1]+=e.items[t].str;return n.map(function(e){return e.trim()})}).then(p)}function t(e){var n=chrome.i18n.getMessage(e.code);return n&&(n=n.replace(/{(\w+)}/g,function(n,t){return e[t]})),n}var r,o="https://assets.lsdsoftware.com/read-aloud/pdf-viewer/web/";/^file:/.test(e)?this.ready=d.loadCss(chrome.runtime.getURL("css/jquery-ui.min.css")).then(d.loadScript.bind(null,chrome.runtime.getURL("js/jquery-ui.min.js"))).then(function(){var e=$("<div>");$("<p>").text(t({code:"uploadpdf_message1",extension_name:chrome.i18n.getMessage("extension_short_name")})).css("color","blue").appendTo(e),$("<p>").text(t({code:"uploadpdf_message2",extension_name:chrome.i18n.getMessage("extension_short_name")})).appendTo(e);var n=$("<form>").attr("action","https://support2.lsdsoftware.com/dropmeafile-readaloud/upload").attr("method","POST").attr("enctype","multipart/form-data").on("submit",function(){r.prop("disabled",!0)}).appendTo(e);$("<input>").attr("type","file").attr("name","fileToUpload").attr("accept","application/pdf").on("change",function(){r.prop("disabled",!$(this).val())}).appendTo(n),$("<br>").appendTo(n),$("<br>").appendTo(n);var r=$("<input>").attr("type","submit").attr("value",chrome.i18n.getMessage("uploadpdf_submit_button")).prop("disabled",!0).appendTo(n);return e.dialog({title:chrome.i18n.getMessage("extension_short_name"),width:450,modal:!0,autoOpen:!1}),{show:function(){e.dialog("open")}}}).then(function(e){r=e}):this.ready=d.loadCss(o+"viewer.css").then(function(){return new Promise(function(e,n){$.ajax(o+"viewer.html",{dataType:"text",success:function(n){var t=n.indexOf(">",n.indexOf("<body"))+1,r=n.indexOf("</body>");document.body.innerHTML=n.slice(t,r),e()},error:function(){n(new Error("Failed to load viewer html"))}})})}).then(function(){$("<link>").appendTo("head").attr({rel:"resource",type:"application/l10n",href:o+"locale/locale.properties"})}).then(d.loadScript.bind(null,o+"../build/pdf.js")).then(function(){var e=function(e){var n=PDFJS[e];Object.defineProperty(PDFJS,e,{enumerable:!0,configurable:!0,get:function(){return o+n},set:function(e){n=e}})};e("imageResourcesPath"),e("workerSrc"),e("cMapUrl")}).then(d.loadScript.bind(null,o+"pdf.viewer.js",function(e){return e.replace("compressed.tracemonkey-pldi-09.pdf","")})).then(function(){return PDFViewerApplication.open(e)}),this.getCurrentIndex=function(){if(r)return 0;var e=PDFViewerApplication.pdfViewer.currentPageNumber;return e?e-1:0},this.getTexts=function(e){if(r)return r.show(),null;var t=PDFViewerApplication.pdfDocument;return e<t.numPages?(PDFViewerApplication.pdfViewer.currentPageNumber=e+1,t.getPage(e+1).then(n)):null}}function i(){function e(){var e=[],n=$(".QuestionArea .question_qtext").get(0);return n&&e.push(n.innerText),$(".AnswerBase").each(function(){(n=$(this).find(".feed_item_answer_user .user").get(0))&&e.push("Answer by "+n.innerText),(n=$(this).find(".rendered_qtext").get(0))&&e.push.apply(e,n.innerText.split(d.paraSplitter)),(n=$(this).find(".AnswerFooter").get(0))&&e.push(n.innerText)}),e}this.getCurrentIndex=function(){return 0},this.getTexts=function(n){return 0==n?e():null}}function s(){function e(){return $("h1:first").add($("> :not(ul, ol), > ul > li, > ol > li",".paragraph:not(.paragraph .paragraph)")).get().map(function(e){var n=c(e);return $(e).is("li")?$(e).index()+1+". "+n:n})}this.getCurrentIndex=function(){return 0},this.getTexts=function(n){return 0==n?e():null}}function l(){function e(){var e=new Date,o=n(100),a=o.reduce(function(e,n){return e+c(n).length},0);if(console.log("Found",o.length,"blocks",a,"chars in",new Date-e,"ms"),a<1e3){var i=(o=n(3)).map(c);console.log("Using lower threshold, found",o.length,"blocks",i.join("").length,"chars");for(var s,p,h=3;h<i.length&&!s;h++){d=t(i,0,h);i[h].length>d.mean+2*d.stdev&&(s=h)}for(h=i.length-4;h>=0&&!p;h--){var d=t(i,h+1,i.length);i[h].length>d.mean+2*d.stdev&&(p=h+1)}(s||p)&&(o=o.slice(s||0,p),console.log("Trimmed",s,p))}for(var g=[],h=0;h<o.length;h++)g.push.apply(g,l(o[h],o[h-1])),g.push(o[h]);return $(g).addClass("read-aloud"),f(i=g.map(r)).filter(u)}function n(e){var n="h1, h2, h3, h4, h5, h6, p, a[href], "+m,t=function(e){return 3==e.nodeType&&e.nodeValue.trim().length>=3},r=function(n){return 1==n.nodeType&&$(n).is("p")&&c(n).length>=e},o=function(n){return g(n,t)&&c(n).length>=e},a=function(e){return g(e,r)},i=function(e){var t=$(e).children(":not("+n+")").get();return t.some(o)||t.some(a)||t.some(i)},s=function(e,n){n&&$(e).data("read-aloud-multi-block",!0),u.push(e)},l=function(){if($(this).is("frame, iframe"))try{l.call(this.contentDocument.body)}catch(e){}else if($(this).is("dl"))s(this);else if($(this).is("ol, ul")){var e=$(this).children().get();e.some(o)?s(this):e.some(a)?s(this,!0):e.some(i)&&s(this,!0)}else if($(this).is("tbody")){var t=$(this).children();t.length>3||t.eq(0).children().length>3?t.get().some(i)&&s(this,!0):t.each(l)}else o(this)?s(this):a(this)?s(this,!0):$(this).children(":not("+n+")").each(l)},u=[];return l.call(document.body),u.filter(function(e){return $(e).is(":visible")&&$(e).offset().left>=0})}function t(e,n,t){void 0==n&&(n=0),void 0==t&&(t=e.length);for(var r=0,o=n;o<t;o++)r+=e[o].length;for(var a=r/(t-n),i=0,o=n;o<t;o++)i+=(e[o].length-a)*(e[o].length-a);return{mean:a,stdev:Math.sqrt(i)}}function r(e){var n=$(e).find(":visible").filter(a).hide();$(e).find("ol, ul").addBack("ol, ul").each(o);var t=$(e).data("read-aloud-multi-block")?$(e).children(":visible").get().map(i):i(e).split(d.paraSplitter);return $(e).find(".read-aloud-numbering").remove(),n.show(),t}function o(){var e=$(this).children(),n=e.length?c(e.get(0)):null;n&&!n.match(/^[(]?(\d|[a-zA-Z][).])/)&&e.each(function(e){$("<span>").addClass("read-aloud-numbering").text(e+1+". ").prependTo(this)})}function a(){var e=$(this).css("float"),n=$(this).css("position");return $(this).is(m)||$(this).is("sup")||"right"==e||"absolute"==n||"fixed"==n}function i(e){return s(e.innerText).trim()}function s(e){return e.replace(/(\w)(\s*?\r?\n)/g,"$1.$2")}function l(e,n){for(var t=[],r=p($(e).find("h1, h2, h3, h4, h5, h6, p").filter(":visible").get(0)),o=h(e,!0);o&&o!=n;){var a=$(o).is(m);if(!a&&1==o.nodeType&&$(o).is(":visible")){var i=p(o);i<r&&(t.push(o),r=i)}o=h(o,a)}return t.reverse()}function p(e){var n=e&&/^H(\d)$/i.exec(e.tagName);return n?Number(n[1]):100}function h(e,n){return $(e).is("body")?null:1==e.nodeType&&!n&&e.lastChild?e.lastChild:e.previousSibling?e.previousSibling:h(e.parentNode,!0)}function g(e,n){for(var t=e.firstChild;t;){if(n(t))return!0;t=t.nextSibling}return!1}function f(e){return[].concat.apply([],e)}var m="select, textarea, button, label, audio, video, dialog, embed, menu, nav, noframes, noscript, object, script, style, svg, aside, footer, #footer";this.getCurrentIndex=function(){return 0},this.getTexts=function(n){return 0==n?e():null}}function c(e){var n=e.innerText;return n?n.trim():""}function u(e){return e}function p(e){for(var n=[],t="",r=0;r<e.length;r++)e[r]?(t&&(/-$/.test(t)?t=t.substr(0,t.length-1):t+=" "),t+=e[r].replace(/-\r?\n/g,""),e[r].match(/[.!?:)"'\u2019\u201d]$/)&&(n.push(t),t="")):t&&(n.push(t),t="");return t&&n.push(t),n}function h(e,n){return function(e){return new Promise(function(n){setTimeout(n,e)})}(500).then(e).then(function(t){return t&&!t.length&&n-500>0?h(e,n-500):t})}window.connect=function(t){window.docReady||(window.docReady=n()),window.docReady.then(function(n){e(t,n)})},window.HtmlDoc=l;var d={paraSplitter:/(?:\s*\r?\n\s*){2,}/};d.loadCss=function(e){return $("head").length||$("<head>").prependTo("html"),$("<link>").appendTo("head").attr({type:"text/css",rel:"stylesheet",href:e}),Promise.resolve()},d.loadScript=function(e,n){return new Promise(function(t,r){$.ajax(e,{dataType:"text",success:function(e){eval.call(window,n?n(e):e),t()},error:function(){r(new Error("Failed to load script"))}})})}}(),function(){if(window.chrome&&chrome.ttsEngine){var e=new RemoteTTS(config.serviceUrl);chrome.ttsEngine.onSpeak.addListener(e.speak),chrome.ttsEngine.onStop.addListener(e.stop)}}();var readAloud=new function(){function ready(){return window.jQuery?Promise.resolve():ajaxGet("https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js").then(eval)}function play(e){return speech?speech.play().then(updateButtons):this.speak((new HtmlDoc).getTexts(0),e)}function speak(e,n){var t=voiceProvider.getLocalVoice(n.lang);return t?(n.voiceName=t.name,n.engine=new LocalTTS(t)):(t=voiceProvider.getRemoteVoice(n.lang),n.voiceName=t?t.voice_name:"default",n.engine=new RemoteTTS(config.serviceUrl)),n.onEnd=function(){speech=null,updateButtons()},speech&&speech.pause(),(speech=new Speech(e,n)).play().then(updateButtons)}function pause(){return speech?speech.pause().then(updateButtons):Promise.resolve()}function updateButtons(){return isPlaying().then(function(e){$(".ra-play").toggle(!e),$(".ra-pause").toggle(e),attribution.toggle(e&&isGoogleTranslate(speech.options.voiceName))})}function isPlaying(){return speech?speech.getState().then(function(e){return"PAUSED"!=e}):Promise.resolve(!1)}function VoiceProvider(){function e(e,n){var t=parseLang(n),r={};return e.forEach(function(e){if(e.lang){var n=parseLang(e.lang);n.lang==t.lang&&(n.rest==t.rest?"female"==e.gender?r.first=r.first||e:r.second=r.second||e:n.rest?"en"==n.lang&&"us"==n.rest?r.fourth=e:r.fourth=r.fourth||e:r.third=r.third||e)}}),r.first||r.second||r.third||r.fourth}window.speechSynthesis&&speechSynthesis.getVoices(),this.getLocalVoice=function(n){return window.speechSynthesis?e(speechSynthesis.getVoices(),n):null},this.getRemoteVoice=function(n){return window.remoteVoices?e(remoteVoices.filter(function(e){return isAmazonPolly(e.voice_name)}),n)||e(remoteVoices.filter(function(e){return isGoogleTranslate(e.voice_name)}),n):null}}function LocalTTS(e){var n;this.speak=function(t,r){n=new SpeechSynthesisUtterance,r.lang&&(n.lang=r.lang),r.pitch&&(n.pitch=r.pitch),r.rate&&(n.rate=r.rate),n.text=t,n.voice=e,r.volume&&(n.volume=r.volume),n.onstart=r.onEvent.bind(null,{type:"start",charIndex:0}),n.onerror=n.onend=r.onEvent.bind(null,{type:"end",charIndex:t.length}),speechSynthesis.speak(n)},this.isSpeaking=function(e){e(speechSynthesis.speaking)},this.stop=function(){n&&(n.onend=null),speechSynthesis.cancel()}}function Attribution(){function e(){n=$("<div/>").appendTo(document.body),$("<div>powered&nbsp;by</div>").css({color:"#888","margin-bottom":"3px"}).appendTo(n),$("<span>G</span>").css("color","#4885ed").appendTo(n),$("<span>o</span>").css("color","#db3236").appendTo(n),$("<span>o</span>").css("color","#f4c20d").appendTo(n),$("<span>g</span>").css("color","#4885ed").appendTo(n),$("<span>l</span>").css("color","#3cba54").appendTo(n),$("<span>e</span>").css("color","#db3236").appendTo(n),$("<span>&nbsp;Translate</span>").css("color","#888").appendTo(n),n.css({display:"none",position:"absolute",padding:"6px",color:"black","background-color":"white","border-radius":"3px","box-shadow":"1px 1px 3px gray","font-family":"Arial, Helvetica, sans-serif","font-size":"small","text-align":"center",cursor:"pointer"}).click(function(){window.open("https://translate.google.com/","_blank")})}var n;this.toggle=function(t){if(t){n||e();var r=$(".ra-pause").offset();r&&(r.left=Math.max(0,r.left+$(".ra-pause").outerWidth()/2-n.outerWidth()/2),r.top+=$(".ra-pause").height()+5,n.css(r).show())}else n&&n.hide()}}var pauseBtn=document.querySelector(".ra-pause");pauseBtn&&(pauseBtn.style.display="none"),window.Promise||ajaxGetCb("https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js",eval);var speech,voiceProvider=new VoiceProvider,attribution=new Attribution;this.play=function(e){return ready().then(play.bind(this,e))},this.speak=function(e,n){return ready().then(speak.bind(this,e,n))},this.pause=pause,this.isPlaying=isPlaying};